import numpy as np

xs = [0]
ys = [0]
patt_ids = [0]

rule all:
  input:
    expand('workflows/correct_rescale/fr_center/out_{cell_id}.png',
           cell_id=config['cells']
    )

rule plot:
  input: 
    #expand('workflows/correct_rescale/fr_center/APC_soma_only_1scale_active_{{cell_id}}-cond_scale_fct{cond_scale_fct}-imp_diff___{imp_diff}.csv',
    #       cond_scale_fct=config['soma_1scale_cond_scl_fct'],
    #       imp_diff = [config['imp_diff'][0]]
    #),
    expand('workflows/correct_rescale/fr_center/APC_effsum_active_{{cell_id}}-cond_scale_fct{cond_scale_fct}-imp_diff___{imp_diff}.csv',
           cond_scale_fct=config['cond_scl_fct'],
           imp_diff=config['imp_diff'],
    ),
    'workflows/correct_rescale/fr_center/APC_full_active_{cell_id}.csv'

  output:
    'workflows/correct_rescale/fr_center/out_{cell_id}.png'
  script:
    'scripts/plot_cond_scale_results.py'

rule merge_soma_only_1scale_active:
  output: 
    'workflows/correct_rescale/fr_center/APC_soma_only_1scale_active_{cell_id}-cond_scale_fct{cond_scale_fct}-imp_diff___{imp_diff}.csv'
  input: 
    expand(
        'workflows/correct_rescale/fr_center/soma_only_1scale_active_data/{{cell_id}}/APC_for_slp-id{patt_id}-norm_power_{norm_power}-cond_scale_fct{{cond_scale_fct}}-imp_diff___{{imp_diff}}.csv',
        patt_id=patt_ids,
        norm_power=config['norm_power']
    )
  script: 
    'scripts/merge_data.py'

rule simulate_soma_only_1scale_active:
  output: 
    'workflows/correct_rescale/fr_center/soma_only_1scale_active_data/{cell_id}/APC_for_slp-id{patt_id}-norm_power_{norm_power}-cond_scale_fct{cond_scale_factor}-imp_diff___{imp_diff}.csv'
  input:
    'workflows/correct_rescale/fr_center/cond_data/{cell_id}/comp_conds_slp-id{patt_id}-norm_power_{norm_power}-imp_diff___{imp_diff}.npy',
    'workflows/correct_rescale/fr_center/cond_data/{cell_id}/temp_protocol__slp-id{patt_id}-norm_power_{norm_power}-imp_diff___{imp_diff}.pickle'
  script: 
    'scripts/simulate_only_1scale_soma.py'

rule merge_effsum_active:
  output:
    'workflows/correct_rescale/fr_center/APC_effsum_active_{cell_id}-cond_scale_fct{cond_scale_fct}-imp_diff___{imp_diff}.csv'
  input:
    expand(
        'workflows/correct_rescale/fr_center/effsum_active_data/{{cell_id}}/APC_for_slp-id{patt_id}-norm_power_{norm_power}-cond_scale_fct{{cond_scale_fct}}-imp_diff___{{imp_diff}}.csv',
        patt_id=patt_ids,
        norm_power=config['norm_power']
    )
  script:
    'scripts/merge_data.py'

rule simulate_effsum_active:
  output: 
    'workflows/correct_rescale/fr_center/effsum_active_data/{cell_id}/APC_for_slp-id{patt_id}-norm_power_{norm_power}-cond_scale_fct{cond_scale_fct}-imp_diff___{imp_diff}.csv'
  input: 
    'workflows/correct_rescale/fr_center/cond_data/{cell_id}/slp-id{patt_id}-norm_power_{norm_power}-imp_diff___{imp_diff}.npy',
    'workflows/correct_rescale/fr_center/cond_data/{cell_id}/temp_protocol__slp-id{patt_id}-norm_power_{norm_power}-imp_diff___{imp_diff}.pickle'
  script: 
    'scripts/simulate_effsum_active.py'

rule calculate_effsum_conductance:
  output:
    'workflows/correct_rescale/fr_center/cond_data/{cell_id}/slp-id{patt_id}-norm_power_{norm_power}-imp_diff___{imp_diff}.npy',
    'workflows/correct_rescale/fr_center/cond_data/{cell_id}/temp_protocol__slp-id{patt_id}-norm_power_{norm_power}-imp_diff___{imp_diff}.pickle',
    'workflows/correct_rescale/fr_center/cond_data/{cell_id}/comp_conds_slp-id{patt_id}-norm_power_{norm_power}-imp_diff___{imp_diff}.npy'
  input:
    'workflows/correct_rescale/data/light_patterns/slp-id{patt_id}.csv',
    'workflows/correct_rescale/data/comp_impedances/{cell_id}.npy'
  script:
    'scripts/calculate_effsum_conductance.py'

rule calc_impedances:
  output:
    'workflows/correct_rescale/data/comp_impedances/{cell_id}.npy'
  script:
    'scripts/calc_ir_tr_impedances.py'

rule merge_full_active:
  output: 
    'workflows/correct_rescale/fr_center/APC_full_active_{cell_id}.csv'
  input: 
    expand(
        'workflows/correct_rescale/fr_center/full_active_data/{{cell_id}}/APC_for_slp-id{patt_id}-norm_power_{norm_power}.csv',
        patt_id=patt_ids,
        norm_power=config['norm_power']
    )
  script: 
    'scripts/merge_data.py'

rule simulate_full_active:
  output: 
    'workflows/correct_rescale/fr_center/full_active_data/{cell_id}/APC_for_slp-id{patt_id}-norm_power_{norm_power}.csv'
  input: 
    'workflows/correct_rescale/data/light_patterns/slp-id{patt_id}.csv'
  script: 
    'scripts/simulate_full_active.py'

rule gen_single_light_patterns:
  output: 
    'workflows/correct_rescale/data/light_patterns/slp-id{patt_id}.csv'
  params:
    diameter_um=config['slp_diameter_um'],
    NA=config['slp_NA'],
    x=xs,
    y=ys
  script:
    'scripts/gen_single_light_patterns.py'
